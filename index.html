<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Auth</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
        }

        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form { display: block; }
        .form.hidden { display: none !important; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; color: #555; }

        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .message {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
    </style>
</head>

<body>
<div class="login-container">

    <div class="logo">
        <h1>Welcome</h1>
        <p>Sign in to your account</p>
    </div>

    <div class="tab-container">
        <button class="tab active" onclick="switchTab('signin')">Sign In</button>
        <button class="tab" onclick="switchTab('signup')">Sign Up</button>
    </div>

    <div id="message-container"></div>

    <form id="signin-form" class="form">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="signin-email" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="signin-password" required>
        </div>
        <button class="btn" type="submit">Sign In</button>
    </form>

    <form id="signup-form" class="form hidden">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" required>
        </div>
        <button class="btn" type="submit">Sign Up</button>
    </form>

</div>

<script>
/* -----------------------------
   Supabase Setup
------------------------------ */
const SUPABASE_URL = "https://hukkjktxwcceajwvnybm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1a2tqa3R4d2NjZWFqd3ZueWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMDE1MjYsImV4cCI6MjA3NTU3NzUyNn0.koOSDJ8m3CfvF8CwN84w-AsZsmUiPJddzsnMOR0XvJE";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -----------------------------
   UI Helpers
------------------------------ */
function showMessage(text, type) {
    const box = document.getElementById("message-container");
    box.innerHTML = `<div class="message ${type}">${text}</div>`;
}

function clearMessage() {
    document.getElementById("message-container").innerHTML = "";
}

function switchTab(tab) {
    document.querySelectorAll(".tab").forEach(btn => {
        btn.classList.toggle("active", btn.textContent.trim() === (tab === "signin" ? "Sign In" : "Sign Up"));
    });

    document.getElementById("signin-form").classList.toggle("hidden", tab !== "signin");
    document.getElementById("signup-form").classList.toggle("hidden", tab !== "signup");

    clearMessage();
}

/* -----------------------------
   Trade Profile Helper
------------------------------ */
async function getUserState(user) {
    const { data: profile } = await supabase
        .from("trade_profiles")
        .select("verified")
        .eq("user_id", user.id)
        .maybeSingle();

    return {
        isNewUser: !profile,
        isVerified: profile?.verified || false
    };
}

/* -----------------------------
   Redirect to Bravo
------------------------------ */
function redirectToBravo(token, state) {
    const params = new URLSearchParams({
        access_token: token,
        isNewUser: state.isNewUser,
        isVerified: state.isVerified
    });

    window.location.href = `https://bravostudio.dynalinks.app/?link=${encodeURIComponent(
        "https://clairecampy.github.io/trade-auth/?" + params.toString()
    )}`;
}

/* -----------------------------
   Sign In
------------------------------ */
document.getElementById("signin-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("signin-email").value;
    const password = document.getElementById("signin-password").value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) return showMessage(error.message, "error");

    const session = data.session;
    const user = data.user;

    const state = await getUserState(user);
    redirectToBravo(session.access_token, state);
});

/* -----------------------------
   Sign Up
------------------------------ */
document.getElementById("signup-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;

    const { data, error } = await supabase.auth.signUp({ email, password });

    if (error) return showMessage(error.message, "error");

    const user = data.user;

    await supabase.from("trade_profiles").upsert({
        user_id: user.id,
        verified: false
    });

    showMessage("Please check your email to confirm your account.", "success");
});
</script>

</body>
</html>
